{
  "name": "Iot-utils",
  "tagline": "IOT operation Utilities & systems management tools - Ansible Scripting Python WinSSH OpenStack VirtualBox MySQL Postgress MongoDB DevOPS Admin",
  "body": "# General utilities\r\n\r\n## 1.- Easy manage environments hosts access\r\nFor easy manage environment hosts access<br>\r\nNeeds:\r\n- Memory remember many clusters, environments, hostnames, ips, etc?\r\n- Quickly find a specific hosts to access it\r\n- Dynamic refresh of all existing hosts at the time\r\n- Inspect trace log of large number of hosts finding specific information\r\n- Command utilities information at the time of large number of hosts\r\n- Easy filter groups of hosts (by example name, type, etc)\r\n- Easy VPN access\r\n\r\n\r\n### 1.1.- Requirements\r\n- No root user for this\r\n- Compatibility for ZSH friends:<br>\r\n  In general, all in this repository is compatible with zsh shell. I known a difference, with zsh, we don't need launch \". command.sh\" when we need to execute and load environments, only to run \"command.sh\" is sufficient.\r\n\r\n\r\n### 1.2.- Install basic software\r\nLaunch:\r\n```\r\n# The git client and dialog window text\r\nsudo yum install dialog git -y\r\n# Use passwords inside scripts\r\nsudo yum install sshpass -y\r\n# Create VPNs\r\nsudo yum install openconnect -y\r\n# A program for making large letters out of ordinary text\r\nsudo yum install figlet -y\r\n# Install NetCat utility for Centos/RH 7 and higher\r\nsudo yum install nmap-ncat -y\r\n# Install NetCat utility for Centos/RH 6 and lower\r\nsudo yum install nc -y\r\n\r\n# For use OpenStack clients and Ansible, we have two options:\r\n\r\n# Installing RPM packages\r\n# Create python virtual environments\r\nsudo yum install python-virtualenv -y\r\nsudo yum install python-virtualenvwrapper -y\r\n\r\n# Or installing Python packages (in system Python)\r\nsudo pip install --upgrade pbr\r\nsudo pip install --upgrade PyYAML\r\nsudo pip install --upgrade virtualenv\r\nsudo pip install --upgrade virtualenvwrapper\r\n\r\n# How to update all python packages:\r\nsudo pip list --outdated | sed 's/(.*//g' | xargs -n1 pip install -U\r\n```\r\n\r\n\r\n### 1.3.- Install Ansible WinRM and OpenStack client tools (Linux)\r\nFirst choose versions\r\n- For Ansible 2.2.0.0 (actual)\r\n```\r\n# Ansible 2.2.0.0 version\r\nANSIBLE_VERSION=2.2.0.0\r\nWINRM_VERSION=0.2.1\r\n```\r\nThen install software\r\n```\r\nrm -rf ~/venv-ansible-${ANSIBLE_VERSION}\r\nvirtualenv ~/venv-ansible-${ANSIBLE_VERSION}\r\nsource ~/venv-ansible-${ANSIBLE_VERSION}/bin/activate\r\n# Update basic Python packages\r\npip install --upgrade pip\r\npip install --upgrade setuptools\r\npip install --upgrade wheel\r\n# Install Ansible package\r\npip install ansible==${ANSIBLE_VERSION}\r\n# Install WIN RM for work with Windows machines\r\npip install pywinrm==${WINRM_VERSION}\r\n```\r\n- Install KILO OpenStack client tools<br>\r\n  If we will work inside OST environments, we need to install the OpenStack client tools. We have actually KILO supported.\r\n```\r\npip install --upgrade python-cinderclient==1.9.0\r\npip install --upgrade python-glanceclient==2.5.0\r\npip install --upgrade python-heatclient==1.6.1\r\npip install --upgrade python-keystoneclient==3.8.0\r\npip install --upgrade python-neutronclient==6.0.0\r\npip install --upgrade python-novaclient==6.0.0\r\npip install --upgrade python-openstackclient==3.4.1\r\npip install --upgrade python-swiftclient==3.2.0\r\npip install --upgrade python-designateclient==2.3.0\r\npip install --upgrade python-ironicclient==1.8.0\r\npip install --upgrade python-magnumclient==2.3.1\r\npip install --upgrade python-mistralclient==2.1.2\r\npip install --upgrade python-troveclient==2.6.0\r\npip install --upgrade shade==1.13.2\r\n```\r\n- Generate python requirements file for backup software versions<br>\r\n  We recommend to generate the requirements file of this python environment\r\n```\r\n# Ansible 2.2.0.0 version\r\nANSIBLE_VERSION=2.2.0.0\r\nWINRM_VERSION=0.2.1\r\n\r\npip freeze > $HOME/requirements-ansible-${ANSIBLE_VERSION}-OST-kilo.txt\r\n```\r\n- To recreate other python virtual environment\r\n```\r\n# Ansible 2.2.0.0 version\r\nANSIBLE_VERSION=2.2.0.0\r\nWINRM_VERSION=0.2.1\r\n\r\nvirtualenv ~/venv-ansible-${ANSIBLE_VERSION}\r\npip install -r $HOME/requirements-ansible-${ANSIBLE_VERSION}-OST-kilo.txt\r\n```\r\n- Download requirements file Ansible\r\n[requirements-ansible-2.2.0.0-OST-kilo.txt](myenvironments/conf/requirements-ansible-2.2.0.0-OST-kilo.txt)\r\n\r\n\r\n### 1.4.- Install Ansible WinRM and OpenStack client tools (Windows with CygWin)\r\nWe need to use Python version 2.7.12 and architecture x86. With CygWin we use own Python installation, but we can have a Windows Python installation (https://www.python.org/ftp/python/2.7.12/python-2.7.12.msi)\r\n- Install CygWin: https://cygwin.com/setup-x86_64.exe (mininal install)\r\n- Setup Cygwin64 Terminal ICON<br>\r\n  Check execute this program as Administrator\r\n- Disable access to Windows Python installation<br>\r\n  Enter in a Cygwin64 session\r\n```\r\necho $'PATH=$(echo $PATH | tr \\':\\' \\'\\\\n\\' | grep -v \"/cygdrive/.*/Python27\" | paste -sd:)' >> .bash_profile\r\nexit\r\n```\r\n- Install base packages<br>\r\n  Enter in a Cygwin64 session\r\n```\r\ncurl https://cygwin.com/setup-x86_64.exe -o setup-x86_64.exe\r\n./setup-x86_64.exe -q --packages python python-devel python-setuptools openssl-devel libffi-devel gcc-g++\r\nexit\r\n\r\n# Description packages\r\n# python: Python language interpreter\r\n# python-devel: Python language interpreter\r\n# python-setuptools: Python package management tool\r\n# openssl-devel: A general purpose cryptography toolkit with TLS implementation (development)\r\n# libffi-devel: Portable foreign function interface library\r\n# gcc-g++: GNU Compiler Collection (C++)\r\n```\r\n- Install Python packages<br>\r\n  Enter in a Cygwin64 session\r\n```\r\neasy_install-2.7 pip\r\npip install --upgrade pip\r\npip install --upgrade setuptools\r\npip install --upgrade wheel\r\npip install virtualenv\r\nexit\r\n```\r\n- Install final software<br>\r\n  Enter in a Cygwin64 session\r\n```\r\n# Information of outdated Python packages\r\npip list --format=columns --outdated\r\n\r\n# Workaround to compile with gcc (u_int header type unknown)\r\nexport CFLAGS=\"-D_DEFAULT_SOURCE\"\r\n# Ansible 2.2.0.0 version\r\nANSIBLE_VERSION=2.2.0.0\r\nWINRM_VERSION=0.2.1\r\n\r\nrm -rf ~/venv-ansible-${ANSIBLE_VERSION}\r\nvirtualenv ~/venv-ansible-${ANSIBLE_VERSION}\r\nsource ~/venv-ansible-${ANSIBLE_VERSION}/bin/activate\r\npip install --upgrade pip\r\npip install --upgrade setuptools\r\npip install --upgrade wheel\r\n# Install Ansible package\r\npip install ansible==${ANSIBLE_VERSION}\r\n# Install WIN RM for work with Windows machines\r\npip install pywinrm==${WINRM_VERSION}\r\n\r\npip install --upgrade python-cinderclient==1.9.0\r\npip install --upgrade python-glanceclient==2.5.0\r\npip install --upgrade python-heatclient==1.6.1\r\npip install --upgrade python-keystoneclient==3.8.0\r\npip install --upgrade python-neutronclient==6.0.0\r\npip install --upgrade python-novaclient==6.0.0\r\npip install --upgrade python-openstackclient==3.4.1\r\npip install --upgrade python-swiftclient==3.2.0\r\npip install --upgrade python-designateclient==2.3.0\r\npip install --upgrade python-ironicclient==1.8.0\r\npip install --upgrade python-magnumclient==2.3.1\r\npip install --upgrade python-mistralclient==2.1.2\r\npip install --upgrade python-troveclient==2.6.0\r\npip install --upgrade shade==1.13.2\r\n\r\npip freeze > $HOME/requirements-ansible-${ANSIBLE_VERSION}-OST-kilo.txt\r\n\r\n# Show list of installed packages\r\ncygcheck -c\r\n```\r\n\r\n\r\n### 1.5.- Install PyCharm IDE Python develop environment\r\nWith no root user\r\n```\r\nmkdir -p $HOME/software\r\ncd $HOME/software\r\nwget https://download.jetbrains.com/python/pycharm-community-5.0.4.tar.gz\r\ncd $HOME\r\ntar xvfz software/xvfz pycharm-community-5.0.4.tar.gz\r\n```\r\n\r\n\r\n### 1.6.- Howto install myenvironments tools\r\nLaunch:\r\n```\r\ncd $HOME\r\ngit clone git@github.com:Telefonica/iot-utils.git\r\ncp -rp iot-utils/myenvironments $HOME\r\ncp -rp iot-utils/tools $HOME\r\nrm -rf iot-utils\r\n```\r\n\r\n### 1.7.- Configure\r\nRead and apply all related task in: `$HOME/myenvironments/conf`\r\n```\r\nbashrcconfignoroot.cnf.template\r\nconfigetchosts.info\r\ngithubprivateenv.sh.template\r\nhowtoconfigpublicprivatekeys.info\r\nlistostenvs.cnf.template\r\nsshconfigclientnoroot.template\r\npycharm.info\r\nvpnconnect.info\r\n```\r\nAs final step we need to ensure that all session terminals are close, and open new terminals\r\n\r\n### 1.8.- Start and howto use\r\n\r\n#### 1.8.1.- Generate host lists of VMWARE environments (VMWARE envs only useful specific for IOT, not use for others)\r\nLaunch:\r\n`noostservers.sh`\r\nThe host lists are stored at `$HOME/myenvironments/envs/iotenvNOOST_*.hosts`\r\n#### 1.8.2.- Generate host lists of OST environments\r\nLaunch:\r\n`ostservers.sh`\r\nThe host lists are stored at `$HOME/myenvironments/envs/iotenvOST_*.hosts`\r\n\r\n#### 1.8.3.- Use of SSH access to hosts\r\nLaunch:\r\n`sshaccess.sh`\r\n\r\n#### 1.8.4.- Configure openstack environments\r\nLaunch:\r\n```\r\n. openstackenv<EPG|DSNAH|PREDSN|PRODSN>.sh\r\n```\r\nOr\r\n```\r\nsource openstackenv<EPG|DSNAH|PREDSN|PRODSN>.sh\r\n```\r\n\r\nClear current environment:\r\n```\r\n. openstackenvCLEAR.sh\r\n```\r\nOr\r\n```\r\nsource openstackenvCLEAR.sh\r\n```\r\n\r\n### 1.8.5.- Manage VPNs\r\nTo manage VPNs we can use vpnconnect.sh. Howto use and help, launch: `vpnconnect.sh` without parameters\r\n\r\n### 1.8.6.- Use PyCharm IDE\r\nThe first time we need to execute PyCharm IDE from startup script (as no root user):\r\n```\r\ncd $HOME/pycharm-community-5.0.4/bin\r\n./pycharm.sh\r\n```\r\nAfter, we close PyCharm IDE, and automatically PyCharm IDe creates a desktop menu launch at `Application->Programming->Pycharm Community Edition`\r\n\r\n\r\n## 2.- Tools\r\nWe have tools for work better. These tools are not robust (by now), then you need to modify it to work properly (Ex. paths)<br>\r\nStored at $HOME/tools\r\n```\r\n# Show diffs (Version X.Y.Z and commit number/release number) of RPMs between Git and RPM installed machines\r\ndiffrpms/findagentbase.sh\r\nHOWTO USE (now only for iot-agent-base):\r\ncd $HOME/tools/diffrpms\r\n./findagentbase.sh\r\nExample output:\r\n*********************************************************\r\nVERIFYING RPM...\r\n*********************************************************\r\nRPMNAME <iot-agent-base>\r\nBRANCH <release/1.3.1>\r\nVERSION <1.3.1>\r\nGITURLREPO <git@github.com:telefonicaid/fiware-IoTAgent-Cplusplus.git>\r\nSHORTSHA1 <57b0ee1>\r\nNUMCOMMITS <117>\r\nOK: ENV <iotenvOST_EPG_201-IOT-demo.hosts PKG <iot-agent-base> EQUAL GITREPO VS INSTALLED RPM\r\nOK: ENV <iotenvOST_EPG_201-IOT-demo.hosts PKG <iot-agent-base> EQUAL GITREPO VS INSTALLED RPM\r\nERROR: ENV <iotenvOST_EPG_201-IoT-int-ext.hosts> PKG <iot-agent-base> DIFFER: GITREPO 1.3.1.117 VS INSTALLED RPM 1.3.1.115\r\nERROR: ENV <iotenvOST_EPG_201-IoT-int-ext.hosts> PKG <iot-agent-base> DIFFER: GITREPO 1.3.1.117 VS INSTALLED RPM 1.3.1.115\r\nOK: ENV <iotenvOST_EPG_264-iot-int.hosts PKG <iot-agent-base> EQUAL GITREPO VS INSTALLED RPM\r\nOK: ENV <iotenvOST_EPG_264-iot-int.hosts PKG <iot-agent-base> EQUAL GITREPO VS INSTALLED RPM\r\nOK: ENV <iotenvOST_PREDSN_IOT-D.hosts PKG <iot-agent-base> EQUAL GITREPO VS INSTALLED RPM\r\nOK: ENV <iotenvOST_PREDSN_IOT-D.hosts PKG <iot-agent-base> EQUAL GITREPO VS INSTALLED RPM\r\nUNKNOWN: ENV <iotenvOST_PRODSN_IOT-L.hosts PKG <iot-agent-base> CANNOT ACCESS\r\nUNKNOWN: ENV <iotenvOST_PRODSN_IOT-L.hosts PKG <iot-agent-base> CANNOT ACCESS\r\n\r\n\r\n# Show diffs of a encrypted file between actual git branch and a commit\r\nansible-vault-git-diff.sh\r\n# Decrypt encrypted Ansible files\r\ndecryptansiblefiles.sh\r\n# Encrypt files to use with Ansible\r\nencryptansiblefiles.sh\r\n# Show differences inside encrypted files of a current git branch and write to diffcreds directory, over git repo directory parent\r\nfindcredentialchanges.sh\r\n# Memory processes sum threads\r\nps_mem.py\r\n# Example:\r\nsudo python ps_mem.py | grep httpd\r\n  4.2 MiB +   6.3 MiB =  10.5 MiB\thttpd (6)\r\n# 10.5 Mib per 6 httpd processes\r\n# Update a git repo and decrypt Ansible encrypted files\r\nupdateiotansible.sh\r\n```\r\n\r\n\r\n## 3.- Windows and PowerShell\r\nWe can configure any Windows host to easy access with ssh and work with Windows console and PowerShell\r\n\r\n### 3.1.- Microsoft has finally integrated into Windows openssh\r\nTo install it, follow the steps:\r\n\r\n- Download a copy of Win-OpenSSH from https://github.com/PowerShell/Win32-OpenSSH\r\n- The last is here: https://github.com/PowerShell/Win32-OpenSSH/releases/download/4_5_2016/OpenSSH-Win64.zip\r\n\r\n- Unzip inside folder C:\\openssh\r\n\r\n- Open a PowerShell console with administrator privileges\r\n\r\n- Generate server keys with\r\n```\r\ncd C:\\openssh\r\n.\\ssh-keygen.exe -A\r\n```\r\n\r\n- If Windows Firewall is activated:\r\nOpen a port for the SSH server in Windows Firewall:<br>\r\nEither run the following PowerShell command (Windows 8 and 2012 or newer only), as the Administrator:\r\n```\r\nNew-NetFirewallRule -Protocol TCP -LocalPort 22 -Direction Inbound -Action Allow -DisplayName SSHD\r\n```\r\nor go to Control Panel > System and Security > Windows Firewall > Advanced Settings > Inbound Rules and add a new rule for port 22.<br>\r\nNOTE: New-NetFirewallRule is for servers only. If you're on a workstation try:\r\n```\r\nnetsh advfirewall firewall add rule name='SSH Port' dir=in action=allow protocol=TCP localport=22\r\n```\r\n\r\n- If you need key-based authentication, run the following to setup the key-auth package\r\n```\r\npowershell.exe .\\install-sshlsa.ps1\r\nRestart-Computer\r\n```\r\n\r\n- Edit C:\\openssh\\sshd_config to configure sftp server:\r\n```\r\nSubsystem sftp C:\\openssh\\sftp-server.exe\r\n```\r\n\r\n- Install SSHD server as service\r\n```\r\n.\\sshd.exe install\r\nStart-Service sshd\r\n```\r\nMake the service start on boot (PowerShell):\r\n```\r\nSet-Service sshd -StartupType Automatic\r\n```\r\nOr manually:\r\n- Start the service and/or configure automatic start:\r\n- Go to Control Panel > System and Security > Administrative Tools and open Services. Locate SSHD service.\r\n- If you want the server to start automatically when your machine is started: Go to Action > Properties.\r\n- In the Properties dialog, change Startup type to Automatic and confirm.\r\n- Start the SSHD service by clicking the Start the service.\r\n\r\nIn your Windows account profile folder (typically in C:\\Users\\username\\.ssh):\r\n- Create the .ssh folder (for the authorized_keys file) in your Windows account profile folder (typically in C:\\Users\\username\\.ssh).\r\n- Do not change permissions for the .ssh and the authorized_keys.\r\n- Configure authorized_keys file and store the PEM file in .ssh folder.\r\n\r\n* Test ssh connection\r\n```\r\nEnter in Windows console\r\nssh user@winmachine\r\nEnter in Powershell console\r\npowershell -File -\r\n```\r\n\r\nExample:\r\n```\r\nssh myuser@caprica.hi.inet\r\nmyuser@caprica.hi.inet's password: \r\nMicrosoft Windows [Versi n 6.1.7601]\r\nCopyright (c) 2009 Microsoft Corporation. Reservados todos los derechos.\r\n\r\nadmin@CAPRICA C:\\Users\\admin>powershell -File -\r\nPS C:\\Users\\admin> Get-EventLog -Log \"Application\"\r\n\r\n   Index Time          EntryType   Source                 InstanceID Message                                                                                                                           \r\n   ----- ----          ---------   ------                 ---------- -------                                                                                                                           \r\n  104935 mar 09 16:04  0           Software Protecti...   1073742727 Se detuvo el servicio de protecci n de software....                                                                               \r\n  104934 mar 09 15:59  0           Software Protecti...   1073742726 Se inici  el servicio de protecci n de software....                                                                               \r\n  104933 mar 09 15:59  Information Software Protecti...   1073742827 El servicio de protecci n de software complet  la comprobaci n del estado de licencias....                                        \r\n  104932 mar 09 15:59  Information Software Protecti...   1073742890 Estado de inicializaci n para objetos de servicio....                                                                             \r\n  104931 mar 09 15:59  Information Software Protecti...   1073742724 Se est  iniciando el servicio de protecci n de software....                                                                       \r\n  104930 mar 09 15:59  Information sshd                            0 No se encontr  la descripci n del Id. de evento '0' en el origen 'sshd'. Es posible que el equipo local no tenga la informaci n...\r\n  104929 mar 09 15:59  Information sshd                            0 No se encontr  la descripci n del Id. de evento '0' en el origen 'sshd'. Es posible que el equipo local no tenga la informaci n...\r\n  104928 mar 09 15:56  Information sshd                            0 No se encontr  la descripci n del Id. de evento '0' en el origen 'sshd'. Es posible que el equipo local no tenga la informaci n...\r\n  104927 mar 09 15:56  Information sshd                            0 No se encontr  la descripci n del Id. de evento '0' en el origen 'sshd'. Es posible que el equipo local no tenga la informaci n...\r\n...\r\nPS C:\\Users\\myuser> exit\r\n\r\nmyuser@CAPRICA C:\\Users\\myuser>exit\r\nConnection to caprica.hi.inet closed.\r\n```\r\n\r\n### 3.2.- Uninstall Win-OpenSSH\r\n- Start Powershell as Administrator\r\n\r\n- Stop the service\r\n```\r\nStop-Service sshd\r\n```\r\n\r\n- Uninstall\r\n```\r\n.\\sshd.exe uninstall\r\npowershell .\\uninstall-sshlsa.ps1\r\nRestart-Computer\r\n```\r\n\r\n\r\n## 4.- Operation process\r\nInside iot-utils/operations we store processes to operate systems. By now, exists the following:\r\n```\r\nbin/changeloglevelnginx.sh\r\n```\r\n- Change (locally, inside a machine with SSH) the level log of nginx server online.\r\n- Help of use:\r\n```\r\n./changeloglevelnginx.sh \r\n****************************************\r\nNGINX CHANGE LOG LEVEL\r\n****************************************\r\n\r\nUsage: changeloglevelnginx.sh <loglevel>\r\nWhere loglevel can be:\r\n    emerg: Emergency situations where the system is in an unusable state.\r\n    alert: Severe situation where action is needed promptly.\r\n    crit: Important problems that need to be addressed.\r\n    error: An Error has occurred. Something was unsuccessful.\r\n    warn: Something out of the ordinary happened, but not a cause for concern.\r\n    notice: Something normal, but worth noting has happened.\r\n    info: An informational message that might be nice to know.\r\n    debug: Debugging information that can be useful to pinpoint where a problem is occurring.\r\n\r\n\r\nFor debug level visit http://nginx.org/en/docs/debugging_log.html\r\n```\r\n- Example of use:\r\n./changeloglevelnginx.sh warn\r\n```\r\n****************************************\r\nNGINX CHANGE LOG LEVEL\r\n****************************************\r\nINFO: Change loglevel to <warn> in file </etc/nginx/conf.d/myweb1.conf>\r\nINFO: Change loglevel to <warn> in file </etc/nginx/conf.d/myweb2.conf>\r\n```\r\n \r\n\r\n## 5.- Manage and administer databases\r\nHere we document tools for manage and administer databases\r\n\r\n### 5.1.- Manage and administer Postgres databases\r\nPostgres is an object-relational database management system (ORDBMS) with an emphasis on extensibility and standards-compliance\r\n\r\n#### 5.1.1.- Troubleshootings\r\nSolutions for Postgres failures\r\n\r\n##### 5.1.1.1.- POSTGRES FAILURE missing chunk number 0 in pg_toasts\r\nWhen appear: hardware failures, cluster failures, and obsoleted Linux Kernels. Steps:\r\n- Stop postgres\r\n\r\n- File system repair\r\n```\r\ne2fsck -fp /dev/<device>\r\n```\r\n\r\n- Add following line to /var/lib/pgsql/9.3/data/postgresql.conf\r\n```\r\nallow_system_table_mods = on\r\n```\r\n\r\n- Enter postgres session in the affected database\r\n```\r\npsql -U postgres db_affected\r\n```\r\n\r\n- From the toast table number of the log failed (here is 2619)\r\n```\r\nSELECT relname from pg_class where oid = 2619;\r\n   relname    \r\n--------------\r\n pg_statistic\r\n(1 row)\r\n```\r\n\r\n- Test that this table is failing\r\n```\r\nSELECT count (*) from pg_statistic;\r\nERROR:  invalid page in block 25 of relation base/16386/12629\r\n```\r\n\r\n- Repair:\r\n```\r\nSET zero_damaged_pages = on;\r\nOutput:\r\nSET\r\n\r\nREINDEX TABLE pg_statistic;\r\nOutput:\r\nWARNING:  invalid page in block 25 of relation base/16386/12629; zeroing out page\r\nERROR:  could not create unique index \"pg_statistic_relid_att_inh_index\"\r\nDETAIL:  Key (starelid, staattnum, stainherit)=(1259, 1, f) is duplicated.\r\n\r\nDELETE from pg_statistic;\r\nOutput:\r\nDELETE 443\r\n\r\nREINDEX table pg_statistic;\r\nOutput:\r\nREINDEX\r\n\r\nVACUUM analyze pg_statistic;\r\nOutput:\r\nWARNING:  relation \"pg_statistic\" page 25 is uninitialized --- fixing\r\nWARNING:  relation \"pg_toast_2619\" page 9 is uninitialized --- fixing\r\nWARNING:  relation \"pg_toast_2619\" page 10 is uninitialized --- fixing\r\nWARNING:  relation \"pg_toast_2619\" page 11 is uninitialized --- fixing\r\nVACUUM\r\n```\r\n\r\n- Exit session and remove from /var/lib/pgsql/9.3/data/postgresql.conf the parameter added previously\r\n```\r\nallow_system_table_mods = on\r\n```\r\n\r\n- Stop and start postgres. Now the database is repaired\r\n\r\n- Do yum update to prevent the same error (Steps only for RH/Centos 6.x)\r\n```\r\nyum update -y bind* coreutils* chkconfig* device-mapper* binutils* dracut* elf* fence* kernel* lvm*\r\n```\r\n\r\n- Reboot the machine\r\n```\r\nreboot\r\n```\r\n### 5.2.- Manage and administer MongoDB databases\r\nThe MongoDB database is a simple no-sql database, oriented to documents using JSON and BSON formats\r\n\r\n#### 5.2.1.- Tools for any version of MongoDB\r\nInside [managemongodb](managemongodb) we have processes to manage many task for MongoDB<br>\r\nThese tools are designed to be used by many people: Developers, Dbas, Release Engineers and Support, under the following concepts: extensive use of regexp expressions, high flexibility, high separated modularity functions, easy configuration and low level design (only use MongoDB tools, nodejs software inside MongoDB tools and Bash)<br>\r\nBecause this design, at beginning the use of these tools can be complicated and difficult<br>\r\nBecause there are bugs in older MongoDB versions 2.x and 3.1.x and 3.2.x (not manage correctly error code status and not manage a lot of special characters, by example the slash \"/\"), we construct specific process to do backups and restore MongoDB databases with these characteristics<br>\r\nFor MongoDB 3.3.x versions and higher these bugs are resolved, and for these versions we will develop better tools\r\n\r\n##### 5.2.1.1.- Howto use\r\nThe use is simple, given that for each task we have a separated and isolated process.\r\n- We need to configure according to our needs the files inside conf directory. The environment variables are self-explained\r\n- All database backups are stored inside backup folder, as specified by the --backupprefix parameter of backup processes\r\n- All commands are inside bin folder, and the use is self-explained. For howto use and help we can execute any command without parameters\r\n\r\n\r\n##### 5.2.1.2.- Commands\r\nHere we list all commands that we can use\r\n\r\n- listdbs.sh\r\n```\r\n*************************************************\r\nList mongo db names\r\n*************************************************\r\n\r\nUsage: listdbs.sh [--help | --alldbs | --db \"searchstring\"]\r\n```\r\n\r\n- listcolls.sh\r\n```\r\n*************************************************\r\nList mongo collection names of a db\r\n*************************************************\r\n\r\nUsage: listcolls.sh [--help | --db \"dbname\" [ --col \"searchstring\" ] ]\r\n```\r\n\r\n- copydb.sh\r\n```\r\n*************************************************\r\nCopy a mongo db\r\n*************************************************\r\n\r\nUsage: copydb.sh [--help | --dbfrom \"dbsource\" --dbto \"dbtarget\"]\r\n```\r\n\r\n- dropdb.sh\r\n```\r\n*************************************************\r\nDrop a mongo db\r\n*************************************************\r\n\r\nUsage: dropdb.sh [--help | --db \"dbname\"]\r\n```\r\n\r\n- rencolls.sh\r\n```\r\n*************************************************\r\nRename collection names of a mongo db\r\n*************************************************\r\n\r\nUsage: rencolls.sh [--help | --db \"dbname\" --find \"searchstring\" --replace \"replacestring\" [ --dochanges ] ]\r\nWhere searchstring can be a regexp, and replacepattern is a string to replace the pattern\r\nExamples:\r\n\r\n- Find collections that start with sth_ and next char not /, and replace by sth_/\r\n  rencolls.sh --db mydbname --find '^sth_(([^/])|$)' --replace 'sth_\\/\\1' --dochanges\r\n- Find collections that start with sth_/ and next any char and replace by sth_\r\n  rencolls.sh --db mydbname --find '^sth_\\/' --replace 'sth_' --dochanges\r\n\r\n- Find collections that start with sth_ and next char not /, and TRY replace by sth_/ (don't apply any changes)\r\n  rencolls.sh --db mydbname --find '^sth_(([^/])|$)' --replace 'sth_\\/\\1'\r\n- Find collections that start with sth_/ and next any char and TRY replace by sth_ (don't apply any changes)\r\n  rencolls.sh --db mydbname --find '^sth_\\/' --replace 'sth_'\r\n```\r\n\r\n- backuponedb.sh\r\n```\r\n*************************************************\r\nBackup a mongo db with BSON format\r\n*************************************************\r\n\r\nUsage: backuponedb.sh [--help | --db \"dbtobackup\" [--backupprefix \"prefix\" default: default] [--rotate <True|othervalue> default: True]]\r\n```\r\n\r\n- backupdbs.sh\r\n```\r\n*************************************************\r\nBackup mongo dbs with BSON format\r\n*************************************************\r\n\r\nUsage: backupdbs.sh [--help | --alldbs | --dbs \"searchstring\" [--backupprefix \"prefix\" default: default] [--rotate <True|othervalue> default: True]]\r\n```\r\n\r\n- restoreonedb.sh\r\n```\r\n*************************************************\r\nRestore a mongo db with BSON format\r\n*************************************************\r\n\r\nUsage: restoreonedb.sh [--help | --dirbackup \"path_abs_dir_backup\" --dbsource \"dbsource\" [--dbtarget \"dbtarget\"]]\r\n```\r\n\r\n- restoredbs.sh\r\n```\r\n*************************************************\r\nRestore mongo dbs with BSON format\r\n*************************************************\r\n\r\nUsage: restoredbs.sh [--help | --dirbackup \"path_abs_dir_backup\" <--dbs \"searchstring\" | --alldbs]>\r\n```\r\n\r\n- STHbackupdbs.sh (a specific process to backup MongoDB databases with slashes inside collection names)\r\n```\r\n*************************************************\r\nSTH backup databases\r\n*************************************************\r\n\r\nUsage: STHbackupdbs.sh [--help | --done]\r\n```\r\n\r\n- STHrestoreonedb.sh (a specific process to restore a MongoDB database with slashes inside collection names)\r\n```\r\n*************************************************\r\nWARNING: Restore databases is very dangerous...\r\nThe original database will be dropped...\r\n*************************************************\r\nExample:\r\nSTHrestoreonedb.sh --dirbackup /home/ec2-user/managemongodbs/backups/backupsth --dbbackup Bsth_db --dborigin sth_db\r\n```\r\n\r\n##### 5.2.1.3.- One example howto backup all MongoDB databases with slashes\r\nWe assume that the MongoDB databases are named as prefix '^sth_'<br>\r\nThen we execute two steps:\r\n\r\n- Backup of all databases no '^sth_'\r\n```\r\n./backupdbs.sh  --dbs '^(?!sth_)' --backupprefix backupnosth\r\n```\r\n\r\n- Backup of all databases '^sth_'\r\n```\r\n/STHbackupdbs.sh --done\r\n```\r\n\r\n#### 5.2.2.- Tools for MongoDB versions 3.3.x and higher\r\nIn the future we realize these tools more simple and efficient that current tools\r\n\r\n\r\n## 6.- Enjoy it...\r\n\r\n",
  "note": "Don't delete this file! It's used internally to help with page regeneration."
}