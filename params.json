{
  "name": "Iot-utils",
  "tagline": "IOT operation Utilities & systems management tools - Ansible Scripting Python WinSSH OpenStack VirtualBox MySQL Postgress MongoDB DevOPS Admin",
  "body": "# General utilities\r\n\r\n## 1.- Easy manage environments hosts access\r\nFor easy manage environment hosts access<br>\r\nNeeds:\r\n- Memory remember many clusters, environments, hostnames, ips, etc?\r\n- Quickly find a specific hosts to access it\r\n- Dynamic refresh of all existing hosts at the time\r\n- Inspect trace log of large number of hosts finding specific information\r\n- Command utilities information at the time of large number of hosts\r\n- Easy filter groups of hosts (by example name, type, etc)\r\n- Easy VPN access\r\n\r\n### 1.1.- Requirements\r\n- No root user for this\r\n- Compatibility for ZSH friends:<br>\r\n  In general, all in this repository is compatible with zsh shell. I known a difference, with zsh, we don't need launch \". command.sh\" when we need to execute and load environments, only to run \"command.sh\" is sufficient.\r\n\r\n### 1.2.- Install basic software\r\nLaunch:\r\n```\r\n# The git client and dialog window text\r\nsudo yum install dialog git -y\r\n# Use passwords inside scripts\r\nsudo yum install sshpass -y\r\n# Create VPNs\r\nsudo yum install openconnect -y\r\n# A program for making large letters out of ordinary text\r\nsudo yum install figlet -y\r\n# Create python virtual environments\r\nsudo yum install virtualenv -y\r\n# Install NetCat utility for Centos/RH 7 and higher\r\nsudo yum install nmap-ncat -y\r\n# Install NetCat utility for Centos/RH 6 and lower\r\nsudo yum install nc -y\r\n```\r\n\r\n### 1.3.- Install Ansible and WinRM\r\nFirst choose versions\r\n\r\n- For Ansible 1.9.6 (obsolete)\r\n```\r\n# Ansible 1.9 version\r\nANSIBLE_VERSION=1.9.6\r\nWINRM_VERSION=0.1.1\r\n```\r\n\r\n- For Ansible 2.0.2.0 (obsolete)\r\n```\r\n# Ansible 2.0.2.0 version\r\nANSIBLE_VERSION=2.0.2.0\r\nWINRM_VERSION=0.1.1\r\n```\r\n\r\n- For Ansible 2.1.1.0 (actual)\r\n```\r\n# Ansible 2.1.1.0 version\r\nANSIBLE_VERSION=2.1.1.0\r\nWINRM_VERSION=0.2.0\r\n```\r\n\r\nThen install software\r\n```\r\nrm -rf ~/venv-ansible-${ANSIBLE_VERSION}\r\nvirtualenv ~/venv-ansible-${ANSIBLE_VERSION}\r\nsource ~/venv-ansible-${ANSIBLE_VERSION}/bin/activate\r\n# Install Ansible package\r\npip install ansible==${ANSIBLE_VERSION}\r\n# Install WIN RM for work with Windows machines\r\npip install pywinrm==${WINRM_VERSION}\r\n```\r\n\r\n### 1.4.- Install OpenStack client tools\r\nIf we will work inside OST environments, we need to install the OpenStack client tools. We have two options, LIBERTY or KILO, but we recommend LIBERTY\r\n\r\n- Install LIBERTY OpenStack (compatible with KILO) client tools\r\n```\r\npip install --upgrade python-barbicanclient==3.3.0\r\npip install --upgrade python-ceilometerclient==1.5.2\r\npip install --upgrade python-cinderclient==1.4.0\r\npip install --upgrade python-congressclient==1.2.0\r\npip install --upgrade python-designateclient==1.5.0\r\npip install --upgrade python-glanceclient==1.1.1\r\npip install --upgrade python-heatclient==0.8.1\r\npip install --upgrade python-ironic-inspector-client==1.2.0\r\npip install --upgrade python-ironicclient==0.8.2\r\npip install --upgrade python-keystoneclient==1.7.4\r\npip install --upgrade python-magnumclient==0.2.1\r\npip install --upgrade python-manilaclient==1.4.0\r\npip install --upgrade python-mistralclient==1.1.0\r\npip install --upgrade python-muranoclient==0.7.3\r\npip install --upgrade python-neutronclient==3.1.1\r\npip install --upgrade python-novaclient==2.30.2\r\npip install --upgrade python-openstackclient==1.7.2\r\npip install --upgrade python-saharaclient==0.11.1\r\npip install --upgrade python-swiftclient==2.6.0\r\npip install --upgrade python-tripleoclient==0.1.1\r\npip install --upgrade python-troveclient==1.3.0\r\npip install --upgrade python-zaqarclient==0.2.0\r\n```\r\n\r\n- Install KILO OpenStack client tools\r\n```\r\npip install --upgrade python-barbicanclient==3.0.3\r\npip install --upgrade python-ceilometerclient==1.1.2\r\npip install --upgrade python-cinderclient==1.1.3\r\npip install --upgrade python-designateclient==1.1.1\r\npip install --upgrade python-glanceclient==0.17.3\r\npip install --upgrade python-heatclient==0.4.0\r\npip install --upgrade python-ironicclient==0.5.1\r\npip install --upgrade python-keystoneclient==1.3.4\r\npip install --upgrade python-manilaclient==1.1.0\r\npip install --upgrade python-muranoclient==0.5.10\r\npip install --upgrade python-neutronclient==2.5.0\r\npip install --upgrade python-novaclient==2.23.3\r\npip install --upgrade python-openstackclient==1.0.5\r\npip install --upgrade python-saharaclient==0.8.0\r\npip install --upgrade python-swiftclient==2.4.0\r\npip install --upgrade python-troveclient==1.0.9\r\n```\r\n\r\n### 1.5.- Generate python requirements file for backup software versions\r\nWe recommend to generate the requirements file of this python environment\r\n\r\n- Launch for Ansible 2.1.1.0 and OST Liberty\r\n```\r\npip freeze > $HOME/requirements-ansible-${ANSIBLE_VERSION}-OST-liberty.txt\r\n```\r\n\r\n- List of requirements file for Ansible 2.1.1.0 and OST Liberty\r\n```\r\ncat $HOME/requirements-ansible-2.1.1.0-OST-liberty.txt \r\nalembic==0.8.8\r\namqp==1.4.9\r\nansible==2.1.1.0\r\nanyjson==0.3.3\r\nappdirs==1.4.0\r\nBabel==2.3.4\r\nbackports.ssl-match-hostname==3.5.0.1\r\nbeautifulsoup4==4.5.1\r\ncachetools==1.1.6\r\ncffi==1.8.2\r\ncliff==2.2.0\r\ncliff-tablib==2.0\r\ncmd2==0.6.8\r\ncontextlib2==0.5.4\r\ncroniter==0.3.12\r\ncryptography==1.5\r\ndebtcollector==1.8.0\r\ndecorator==4.0.10\r\ndocker-py==1.7.2\r\ndogpile.cache==0.6.2\r\nenum34==1.1.6\r\neventlet==0.19.0\r\nfasteners==0.14.1\r\nfuncsigs==1.0.2\r\nfunctools32==3.2.3.post2\r\nfutures==3.0.5\r\nfuturist==0.18.0\r\ngreenlet==0.4.10\r\nhttplib2==0.9.2\r\nidna==2.1\r\nipaddress==1.0.17\r\niso8601==0.1.11\r\nJinja2==2.8\r\njsonpatch==1.14\r\njsonpointer==1.10\r\njsonschema==2.5.1\r\nkeystoneauth1==2.12.1\r\nkeystonemiddleware==4.9.0\r\nkombu==3.0.35\r\nlogutils==0.3.3\r\nlxml==3.6.4\r\nMako==1.0.4\r\nMarkupSafe==0.23\r\nmistral==2.0.0\r\nmock==2.0.0\r\nmonotonic==1.2\r\nmsgpack-python==0.4.8\r\nnetaddr==0.7.18\r\nnetifaces==0.10.5\r\nnetworkx==1.11\r\nopenstacksdk==0.9.6\r\nos-client-config==1.21.1\r\nos-cloud-config==0.4.1\r\nosc-lib==1.1.0\r\noslo.concurrency==3.14.0\r\noslo.config==3.17.0\r\noslo.context==2.9.0\r\noslo.db==4.13.3\r\noslo.i18n==3.9.0\r\noslo.log==3.16.0\r\noslo.messaging==5.10.0\r\noslo.middleware==3.19.0\r\noslo.serialization==2.13.0\r\noslo.service==1.16.0\r\noslo.utils==3.16.0\r\nparamiko==2.0.2\r\npasslib==1.6.5\r\nPaste==2.0.3\r\nPasteDeploy==1.5.2\r\npbr==1.10.0\r\npecan==1.1.2\r\npika==0.10.0\r\npika-pool==0.1.3\r\nply==3.9\r\npositional==1.1.1\r\nprettytable==0.7.2\r\npyasn1==0.1.9\r\npycadf==2.4.0\r\npycparser==2.14\r\npycrypto==2.6.1\r\npyinotify==0.9.6\r\npyOpenSSL==16.1.0\r\npyparsing==2.1.9\r\npython-barbicanclient==4.1.0\r\npython-ceilometerclient==2.6.1\r\npython-cinderclient==1.9.0\r\npython-congressclient==1.2.0\r\npython-dateutil==2.5.3\r\npython-designateclient==1.5.0\r\npython-editor==1.0.1\r\npython-glanceclient==2.5.0\r\npython-heatclient==1.4.0\r\npython-ironic-inspector-client==1.9.0\r\npython-ironicclient==1.7.0\r\npython-keystoneclient==3.5.0\r\npython-magnumclient==0.2.1\r\npython-manilaclient==1.4.0\r\npython-mistralclient==2.1.1\r\npython-muranoclient==0.7.3\r\npython-neutronclient==6.0.0\r\npython-novaclient==6.0.0\r\npython-ntlm3==1.0.2\r\npython-openstackclient==3.2.0\r\npython-saharaclient==0.11.1\r\npython-swiftclient==3.1.0\r\npython-tripleoclient==0.1.1\r\npython-troveclient==1.3.0\r\npython-zaqarclient==0.2.0\r\npytz==2016.6.1\r\npywinrm==0.2.0\r\nPyYAML==3.12\r\nrepoze.lru==0.6\r\nrequests==2.11.1\r\nrequests-ntlm==0.3.0\r\nrequestsexceptions==1.1.3\r\nretrying==1.3.3\r\nrfc3986==0.4.1\r\nRoutes==2.3.1\r\nsimplegeneric==0.8.1\r\nsimplejson==3.8.2\r\nsingledispatch==3.4.0.3\r\nsix==1.10.0\r\nSQLAlchemy==1.0.15\r\nsqlalchemy-migrate==0.10.0\r\nsqlparse==0.2.1\r\nstevedore==1.17.1\r\ntablib==0.11.2\r\nTempita==0.5.2\r\ntooz==1.43.0\r\ntripleo-common==5.0.0\r\nunicodecsv==0.14.1\r\nvoluptuous==0.9.3\r\nwaitress==1.0.0\r\nwarlock==1.2.0\r\nWebOb==1.6.1\r\nwebsocket-client==0.37.0\r\nWebTest==2.0.23\r\nwrapt==1.10.8\r\nWSME==0.8.0\r\nxmltodict==0.10.2\r\nyaql==1.1.1\r\n```\r\n\r\n- To recreate other python virtual environment\r\n```\r\nvirtualenv ~/venv-ansible-${ANSIBLE_VERSION}\r\npip install -r $HOME/requirements-ansible-${ANSIBLE_VERSION}-OST-liberty.txt\r\n```\r\n\r\n### 1.6.- Install PyCharm IDE Python develop environment\r\nWith no root user\r\n```\r\nmkdir -p $HOME/software\r\ncd $HOME/software\r\nwget https://download.jetbrains.com/python/pycharm-community-5.0.4.tar.gz\r\ncd $HOME\r\ntar xvfz software/xvfz pycharm-community-5.0.4.tar.gz\r\n```\r\n\r\n### 1.7.- Fix Ansible bug https://github.com/ansible/ansible/issues/14438 for Ansible 2.0.2.0\r\nThe problem: If a role is skipped due to failed conditional, the role's dependencies are skipped in subsequent calls\r\n\r\n####1.7.1.- Apply the [ansible.patch14438](patchs/ansible.patch14438.patch)\r\n- Test python version and location that you used\r\n```\r\npython --version\r\nwhich python\r\n```\r\n- Test Ansible version (check that is 2.0.2.0)\r\n```\r\nansible --version\r\n```\r\n- Download\r\n```\r\ncd <anydirectory>\r\nwget -N https://raw.github.com/Telefonica/iot-utils/develop/patchs/ansible.patch14438.patch\r\n```\r\n- Apply patch automatically (one option)\r\n```\r\ncd $(python -c 'import os; import importlib; module = importlib.import_module(\"ansible\"); print os.path.dirname(module.__file__)')\r\nsudo patch -p0 < <anydirectory>/ansible.patch14438.patch\r\n```\r\n- Apply patch manually (other option)\r\n```\r\ncd $(python -c 'import os; import importlib; module = importlib.import_module(\"ansible\"); print os.path.dirname(module.__file__)')\r\nEdit the file playbook/block.py and delete the lines specified in the patch file (from line 271, delete three lines)\r\nEdit the file playbook/role/__init__.py and delete the lines specified in the patch file (from line 118, delete ten lines)\r\n```\r\n\r\n### 1.8.- Howto install myenvironments tools\r\nLaunch:\r\n```\r\ncd $HOME\r\ngit clone git@github.com:Telefonica/iot-utils.git\r\ncp -rp iot-utils/myenvironments $HOME\r\ncp -rp iot-utils/tools $HOME\r\nrm -rf iot-utils\r\n```\r\n\r\n### 1.9.- Configure\r\nRead and apply all related task in: `$HOME/myenvironments/conf`\r\n```\r\nbashrcconfignoroot.cnf.template\r\nconfigetchosts.info\r\ngithubprivateenv.sh.template\r\nhowtoconfigpublicprivatekeys.info\r\nlistostenvs.cnf.template\r\nsshconfigclientnoroot.template\r\npycharm.info\r\nvpnconnect.info\r\n```\r\nAs final step we need to ensure that all session terminals are close, and open new terminals\r\n\r\n### 1.10.- Start and howto use\r\n\r\n#### 1.10.1.- Generate host lists of VMWARE environments (VMWARE envs only useful specific for IOT, not use for others)\r\nLaunch:\r\n`noostservers.sh`\r\nThe host lists are stored at `$HOME/myenvironments/envs/iotenvNOOST_*.hosts`\r\n#### 1.10.2.- Generate host lists of OST environments\r\nLaunch:\r\n`ostservers.sh`\r\nThe host lists are stored at `$HOME/myenvironments/envs/iotenvOST_*.hosts`\r\n\r\n#### 1.10.3.- Use of SSH access to hosts\r\nLaunch:\r\n`sshaccess.sh`\r\n\r\n#### 1.10.4.- Manually configure openstack environments\r\n- For EPG launch (Selecting desired tenant, and green color):\r\n  ```. openstackenvEPG.sh```\r\n- For PREDSN launch (blue color):\r\n  ```. openstackenvPREDSN.sh```\r\n- For PRODSN launch (red color... Warning!!!):\r\n  ```. openstackenvPRODSN.sh```\r\n- Clear current environment:\r\n  ```. openstackenvCLEAR.sh```\r\n\r\n### 1.10.5.- Manage VPNs\r\nTo manage VPNs we can use vpnconnect.sh. Howto use and help, launch: `vpnconnect.sh` whitout parameters\r\n\r\n### 1.10.6.- Use PyCharm IDE\r\nThe first time we need to execute PyCharm IDE from startup script (as no root user):\r\n```\r\ncd $HOME/pycharm-community-5.0.4/bin\r\n./pycharm.sh\r\n```\r\nAfter, we close PyCharm IDE, and automatically PyCharm IDe creates a desktop menu launch at `Application->Programming->Pycharm Community Edition`\r\n\r\n\r\n## 2.- Tools\r\nWe have tools for work better. These tools are not robust (by now), then you need to modify it to work properly (Ex. paths).\r\n\r\nStored at $HOME/tools\r\n```\r\n# Show diffs (Version X.Y.Z and commit number/release number) of RPMs between Git and RPM installed machines\r\ndiffrpms/findagentbase.sh\r\nHOWTO USE (now only for iot-agent-base):\r\ncd $HOME/tools/diffrpms\r\n./findagentbase.sh\r\nExample output:\r\n*********************************************************\r\nVERIFYING RPM...\r\n*********************************************************\r\nRPMNAME <iot-agent-base>\r\nBRANCH <release/1.3.1>\r\nVERSION <1.3.1>\r\nGITURLREPO <git@github.com:telefonicaid/fiware-IoTAgent-Cplusplus.git>\r\nSHORTSHA1 <57b0ee1>\r\nNUMCOMMITS <117>\r\nOK: ENV <iotenvOST_EPG_201-IOT-demo.hosts PKG <iot-agent-base> EQUAL GITREPO VS INSTALLED RPM\r\nOK: ENV <iotenvOST_EPG_201-IOT-demo.hosts PKG <iot-agent-base> EQUAL GITREPO VS INSTALLED RPM\r\nERROR: ENV <iotenvOST_EPG_201-IoT-int-ext.hosts> PKG <iot-agent-base> DIFFER: GITREPO 1.3.1.117 VS INSTALLED RPM 1.3.1.115\r\nERROR: ENV <iotenvOST_EPG_201-IoT-int-ext.hosts> PKG <iot-agent-base> DIFFER: GITREPO 1.3.1.117 VS INSTALLED RPM 1.3.1.115\r\nOK: ENV <iotenvOST_EPG_264-iot-int.hosts PKG <iot-agent-base> EQUAL GITREPO VS INSTALLED RPM\r\nOK: ENV <iotenvOST_EPG_264-iot-int.hosts PKG <iot-agent-base> EQUAL GITREPO VS INSTALLED RPM\r\nOK: ENV <iotenvOST_PREDSN_IOT-D.hosts PKG <iot-agent-base> EQUAL GITREPO VS INSTALLED RPM\r\nOK: ENV <iotenvOST_PREDSN_IOT-D.hosts PKG <iot-agent-base> EQUAL GITREPO VS INSTALLED RPM\r\nUNKNOWN: ENV <iotenvOST_PRODSN_IOT-L.hosts PKG <iot-agent-base> CANNOT ACCESS\r\nUNKNOWN: ENV <iotenvOST_PRODSN_IOT-L.hosts PKG <iot-agent-base> CANNOT ACCESS\r\n\r\n\r\n# Show diffs of a encrypted file between actual git branch and a commit\r\nansible-vault-git-diff.sh\r\n# Decrypt encrypted Ansible files\r\ndecryptansiblefiles.sh\r\n# Encrypt files to use with Ansible\r\nencryptansiblefiles.sh\r\n# Show differences inside encrypted files of a current git branch and write to diffcreds directory, over git repo directory parent\r\nfindcredentialchanges.sh\r\n# Memory processes sum threads\r\nps_mem.py\r\n# Example:\r\nsudo python ps_mem.py | grep httpd\r\n  4.2 MiB +   6.3 MiB =  10.5 MiB\thttpd (6)\r\n# 10.5 Mib per 6 httpd processes\r\n# Update a git repo and decrypt Ansible encrypted files\r\nupdateiotansible.sh\r\n```\r\n\r\n\r\n## 3.- Windows and PowerShell\r\nWe can configure any Windows host to easy access with ssh and work with Windows console and PowerShell\r\n\r\n### 3.1.- Microsoft has finally integrated into Windows openssh. To install it, follow the steps:\r\n\r\n- Download a copy of Win-OpenSSH from https://github.com/PowerShell/Win32-OpenSSH.<br>The last is here: https://github.com/PowerShell/Win32-OpenSSH/releases/download/4_5_2016/OpenSSH-Win64.zip\r\n\r\n- Unzip inside folder C:\\openssh\r\n\r\n- Open a PowerShell console with administrator privileges\r\n\r\n- Generate server keys with\r\n```\r\ncd C:\\openssh\r\n.\\ssh-keygen.exe -A\r\n```\r\n\r\n- If Windows Firewall is activated:\r\nOpen a port for the SSH server in Windows Firewall:\r\nEither run the following PowerShell command (Windows 8 and 2012 or newer only), as the Administrator:\r\n```\r\nNew-NetFirewallRule -Protocol TCP -LocalPort 22 -Direction Inbound -Action Allow -DisplayName SSHD\r\n```\r\nor go to Control Panel > System and Security > Windows Firewall > Advanced Settings > Inbound Rules and add a new rule for port 22.\r\n\r\nNOTE: New-NetFirewallRule is for servers only. If you're on a workstation try:\r\n```\r\nnetsh advfirewall firewall add rule name='SSH Port' dir=in action=allow protocol=TCP localport=22\r\n```\r\n\r\n- If you need key-based authentication, run the following to setup the key-auth package\r\n```\r\npowershell.exe .\\install-sshlsa.ps1\r\nRestart-Computer\r\n```\r\n\r\n- Edit C:\\openssh\\sshd_config to configure sftp server:\r\n```\r\nSubsystem sftp C:\\openssh\\sftp-server.exe\r\n```\r\n\r\n- Install SSHD server as service\r\n```\r\n.\\sshd.exe install\r\nStart-Service sshd\r\n```\r\nMake the service start on boot (PowerShell):\r\n```\r\nSet-Service sshd -StartupType Automatic\r\n```\r\nOr manually:\r\nStart the service and/or configure automatic start:\r\nGo to Control Panel > System and Security > Administrative Tools and open Services. Locate SSHD service.\r\nIf you want the server to start automatically when your machine is started: Go to Action > Properties. In the Properties dialog, change Startup type to Automatic and confirm.\r\nStart the SSHD service by clicking the Start the service.\r\n\r\n- In your Windows account profile folder (typically in C:\\Users\\username\\.ssh)\r\nCreate the .ssh folder (for the authorized_keys file) in your Windows account profile folder (typically in C:\\Users\\username\\.ssh).\r\nDo not change permissions for the .ssh and the authorized_keys.\r\nConfigure authorized_keys file and store the PEM file in .ssh folder.\r\n\r\n- Test ssh connection\r\n```\r\nEnter in Windows console\r\nssh user@winmachine\r\nEnter in Powershell console\r\npowershell -File -\r\n```\r\n\r\nExample:\r\n```\r\nssh myuser@caprica.hi.inet\r\nmyuser@caprica.hi.inet's password: \r\nMicrosoft Windows [Versi n 6.1.7601]\r\nCopyright (c) 2009 Microsoft Corporation. Reservados todos los derechos.\r\n\r\nadmin@CAPRICA C:\\Users\\admin>powershell -File -\r\nPS C:\\Users\\admin> Get-EventLog -Log \"Application\"\r\n\r\n   Index Time          EntryType   Source                 InstanceID Message                                                                                                                           \r\n   ----- ----          ---------   ------                 ---------- -------                                                                                                                           \r\n  104935 mar 09 16:04  0           Software Protecti...   1073742727 Se detuvo el servicio de protecci n de software....                                                                               \r\n  104934 mar 09 15:59  0           Software Protecti...   1073742726 Se inici  el servicio de protecci n de software....                                                                               \r\n  104933 mar 09 15:59  Information Software Protecti...   1073742827 El servicio de protecci n de software complet  la comprobaci n del estado de licencias....                                        \r\n  104932 mar 09 15:59  Information Software Protecti...   1073742890 Estado de inicializaci n para objetos de servicio....                                                                             \r\n  104931 mar 09 15:59  Information Software Protecti...   1073742724 Se est  iniciando el servicio de protecci n de software....                                                                       \r\n  104930 mar 09 15:59  Information sshd                            0 No se encontr  la descripci n del Id. de evento '0' en el origen 'sshd'. Es posible que el equipo local no tenga la informaci n...\r\n  104929 mar 09 15:59  Information sshd                            0 No se encontr  la descripci n del Id. de evento '0' en el origen 'sshd'. Es posible que el equipo local no tenga la informaci n...\r\n  104928 mar 09 15:56  Information sshd                            0 No se encontr  la descripci n del Id. de evento '0' en el origen 'sshd'. Es posible que el equipo local no tenga la informaci n...\r\n  104927 mar 09 15:56  Information sshd                            0 No se encontr  la descripci n del Id. de evento '0' en el origen 'sshd'. Es posible que el equipo local no tenga la informaci n...\r\n...\r\nPS C:\\Users\\myuser> exit\r\n\r\nmyuser@CAPRICA C:\\Users\\myuser>exit\r\nConnection to caprica.hi.inet closed.\r\n```\r\n\r\n### 3.2.- Uninstall Win-OpenSSH\r\n- Start Powershell as Administrator\r\n\r\n- Stop the service\r\n```\r\nStop-Service sshd\r\n```\r\n\r\n- Uninstall\r\n```\r\n.\\sshd.exe uninstall\r\npowershell .\\uninstall-sshlsa.ps1\r\nRestart-Computer\r\n```\r\n\r\n\r\n## 4.- Operation process\r\nInside iot-utils/operations we store processes to operate systems.\r\nBy now, exists the following:\r\n```\r\nbin/changeloglevelnginx.sh\r\n```\r\n- Change (locally, inside a machine with SSH) the level log of nginx server online.\r\n- Help of use:\r\n```\r\n./changeloglevelnginx.sh \r\n****************************************\r\nNGINX CHANGE LOG LEVEL\r\n****************************************\r\n\r\nUsage: changeloglevelnginx.sh <loglevel>\r\nWhere loglevel can be:\r\n    emerg: Emergency situations where the system is in an unusable state.\r\n    alert: Severe situation where action is needed promptly.\r\n    crit: Important problems that need to be addressed.\r\n    error: An Error has occurred. Something was unsuccessful.\r\n    warn: Something out of the ordinary happened, but not a cause for concern.\r\n    notice: Something normal, but worth noting has happened.\r\n    info: An informational message that might be nice to know.\r\n    debug: Debugging information that can be useful to pinpoint where a problem is occurring.\r\n\r\n\r\nFor debug level visit http://nginx.org/en/docs/debugging_log.html\r\n```\r\n- Example of use:\r\n./changeloglevelnginx.sh warn\r\n```\r\n****************************************\r\nNGINX CHANGE LOG LEVEL\r\n****************************************\r\nINFO: Change loglevel to <warn> in file </etc/nginx/conf.d/myweb1.conf>\r\nINFO: Change loglevel to <warn> in file </etc/nginx/conf.d/myweb2.conf>\r\n```\r\n \r\n\r\n## 5.- Manage and administer databases\r\nHere we document tools for manage and administer databases\r\n\r\n### 5.1.- Manage and administer Postgres databases\r\nPostgres is an object-relational database management system (ORDBMS) with an emphasis on extensibility and standards-compliance\r\n\r\n#### 5.1.1.- Troubleshootings\r\nSolutions for Postgres failures\r\n\r\n##### 5.1.1.1.- POSTGRES FAILURE missing chunk number 0 in pg_toasts\r\nWhen appear: hardware failures, cluster failures, and obsoleted Linux Kernels. Steps:\r\n- Stop postgres\r\n\r\n- File system repair\r\n```\r\ne2fsck -fp /dev/<device>\r\n```\r\n\r\n- Add following line to /var/lib/pgsql/9.3/data/postgresql.conf\r\n```\r\nallow_system_table_mods = on\r\n```\r\n\r\n- Enter postgres session in the affected database\r\n```\r\npsql -U postgres db_affected\r\n```\r\n\r\n- From the toast table number of the log failed (here is 2619)\r\n```\r\nSELECT relname from pg_class where oid = 2619;\r\n   relname    \r\n--------------\r\n pg_statistic\r\n(1 row)\r\n```\r\n\r\n- Test that this table is failing\r\n```\r\nSELECT count (*) from pg_statistic;\r\nERROR:  invalid page in block 25 of relation base/16386/12629\r\n```\r\n\r\n- Repair:\r\n```\r\nSET zero_damaged_pages = on;\r\nOutput:\r\nSET\r\n\r\nREINDEX TABLE pg_statistic;\r\nOutput:\r\nWARNING:  invalid page in block 25 of relation base/16386/12629; zeroing out page\r\nERROR:  could not create unique index \"pg_statistic_relid_att_inh_index\"\r\nDETAIL:  Key (starelid, staattnum, stainherit)=(1259, 1, f) is duplicated.\r\n\r\nDELETE from pg_statistic;\r\nOutput:\r\nDELETE 443\r\n\r\nREINDEX table pg_statistic;\r\nOutput:\r\nREINDEX\r\n\r\nVACUUM analyze pg_statistic;\r\nOutput:\r\nWARNING:  relation \"pg_statistic\" page 25 is uninitialized --- fixing\r\nWARNING:  relation \"pg_toast_2619\" page 9 is uninitialized --- fixing\r\nWARNING:  relation \"pg_toast_2619\" page 10 is uninitialized --- fixing\r\nWARNING:  relation \"pg_toast_2619\" page 11 is uninitialized --- fixing\r\nVACUUM\r\n```\r\n\r\n- Exit session and remove from /var/lib/pgsql/9.3/data/postgresql.conf the parameter added previously\r\n```\r\nallow_system_table_mods = on\r\n```\r\n\r\n- Stop and start postgres. Now the database is repaired\r\n\r\n- Do yum update to prevent the same error (Steps only for RH/Centos 6.x)\r\n```\r\nyum update -y bind* coreutils* chkconfig* device-mapper* binutils* dracut* elf* fence* kernel* lvm*\r\n```\r\n\r\n- Reboot the machine\r\n```\r\nreboot\r\n```\r\n### 5.2.- Manage and administer MongoDB databases\r\nThe MongoDB database is a simple no-sql database, oriented to documents using JSON and BSON formats\r\n\r\n#### 5.2.1.- Tools for any version of MongoDB\r\nInside [managemongodb](managemongodb) we have processes to manage many task for MongoDB<br>\r\nThese tools are designed to be used by many people: Developers, Dbas, Release Engineers and Support, under the following concepts: extensive use of regexp expressions, high flexibility, high separated modularity functions, easy configuration and low level design (only use MongoDB tools, nodejs software inside MongoDB tools and Bash)<br>\r\nBecause this design, at beginning the use of these tools can be complicated and difficult<br>\r\nBecause there are bugs in older MongoDB versions 2.x and 3.1.x and 3.2.x (not manage correctly error code status and not manage a lot of special characters, by example the slash \"/\"), we construct specific process to do backups and restore MongoDB databases with these characteristics<br>\r\nFor MongoDB 3.3.x versions and higher these bugs are resolved, and for these versions we will develop better tools\r\n\r\n##### 5.2.1.1.- Howto use\r\nThe use is simple, given that for each task we have a separated and isolated process.\r\n- We need to configure according to our needs the files inside conf directory. The environment variables are self-explained\r\n- All database backups are stored inside backup folder, as specified by the --backupprefix parameter of backup processes\r\n- All commands are inside bin folder, and the use is self-explained. For howto use and help we can execute any command without parameters\r\n\r\n\r\n##### 5.2.1.2.- Commands\r\nHere we list all commands that we can use\r\n\r\n- listdbs.sh\r\n```\r\n*************************************************\r\nList mongo db names\r\n*************************************************\r\n\r\nUsage: listdbs.sh [--help | --alldbs | --db \"searchstring\"]\r\n```\r\n\r\n- listcolls.sh\r\n```\r\n*************************************************\r\nList mongo collection names of a db\r\n*************************************************\r\n\r\nUsage: listcolls.sh [--help | --db \"dbname\" [ --col \"searchstring\" ] ]\r\n```\r\n\r\n- copydb.sh\r\n```\r\n*************************************************\r\nCopy a mongo db\r\n*************************************************\r\n\r\nUsage: copydb.sh [--help | --dbfrom \"dbsource\" --dbto \"dbtarget\"]\r\n```\r\n\r\n- dropdb.sh\r\n```\r\n*************************************************\r\nDrop a mongo db\r\n*************************************************\r\n\r\nUsage: dropdb.sh [--help | --db \"dbname\"]\r\n```\r\n\r\n- rencolls.sh\r\n```\r\n*************************************************\r\nRename collection names of a mongo db\r\n*************************************************\r\n\r\nUsage: rencolls.sh [--help | --db \"dbname\" --find \"searchstring\" --replace \"replacestring\" [ --dochanges ] ]\r\nWhere searchstring can be a regexp, and replacepattern is a string to replace the pattern\r\nExamples:\r\n\r\n- Find collections that start with sth_ and next char not /, and replace by sth_/\r\n  rencolls.sh --db mydbname --find '^sth_(([^/])|$)' --replace 'sth_\\/\\1' --dochanges\r\n- Find collections that start with sth_/ and next any char and replace by sth_\r\n  rencolls.sh --db mydbname --find '^sth_\\/' --replace 'sth_' --dochanges\r\n\r\n- Find collections that start with sth_ and next char not /, and TRY replace by sth_/ (don't apply any changes)\r\n  rencolls.sh --db mydbname --find '^sth_(([^/])|$)' --replace 'sth_\\/\\1'\r\n- Find collections that start with sth_/ and next any char and TRY replace by sth_ (don't apply any changes)\r\n  rencolls.sh --db mydbname --find '^sth_\\/' --replace 'sth_'\r\n```\r\n\r\n- backuponedb.sh\r\n```\r\n*************************************************\r\nBackup a mongo db with BSON format\r\n*************************************************\r\n\r\nUsage: backuponedb.sh [--help | --db \"dbtobackup\" [--backupprefix \"prefix\" default: default] [--rotate <True|othervalue> default: True]]\r\n```\r\n\r\n- backupdbs.sh\r\n```\r\n*************************************************\r\nBackup mongo dbs with BSON format\r\n*************************************************\r\n\r\nUsage: backupdbs.sh [--help | --alldbs | --dbs \"searchstring\" [--backupprefix \"prefix\" default: default] [--rotate <True|othervalue> default: True]]\r\n```\r\n\r\n- restoreonedb.sh\r\n```\r\n*************************************************\r\nRestore a mongo db with BSON format\r\n*************************************************\r\n\r\nUsage: restoreonedb.sh [--help | --dirbackup \"path_abs_dir_backup\" --dbsource \"dbsource\" [--dbtarget \"dbtarget\"]]\r\n```\r\n\r\n- restoredbs.sh\r\n```\r\n*************************************************\r\nRestore mongo dbs with BSON format\r\n*************************************************\r\n\r\nUsage: restoredbs.sh [--help | --dirbackup \"path_abs_dir_backup\" <--dbs \"searchstring\" | --alldbs]>\r\n```\r\n\r\n- STHbackupdbs.sh (a specific process to backup MongoDB databases with slashes inside collection names)\r\n```\r\n*************************************************\r\nSTH backup databases\r\n*************************************************\r\n\r\nUsage: STHbackupdbs.sh [--help | --done]\r\n```\r\n\r\n- STHrestoreonedb.sh (a specific process to restore a MongoDB database with slashes inside collection names)\r\n```\r\n*************************************************\r\nWARNING: Restore databases is very dangerous...\r\nThe original database will be dropped...\r\n*************************************************\r\nExample:\r\nSTHrestoreonedb.sh --dirbackup /home/ec2-user/managemongodbs/backups/backupsth --dbbackup Bsth_db --dborigin sth_db\r\n```\r\n\r\n##### 5.2.1.3.- One example howto backup all MongoDB databases with slashes\r\nWe assume that the MongoDB databases are named as prefix '^sth_'<br>\r\nThen we execute two steps:\r\n\r\n- Backup of all databases no '^sth_'\r\n```\r\n./backupdbs.sh  --dbs '^(?!sth_)' --backupprefix backupnosth\r\n```\r\n\r\n- Backup of all databases '^sth_'\r\n```\r\n/STHbackupdbs.sh --done\r\n```\r\n\r\n#### 5.2.2.- Tools for MongoDB versions 3.3.x and higher\r\nIn the future we realize these tools more simple and efficient that current tools\r\n\r\n\r\n## 6.- Enjoy it...\r\n\r\n\r\n",
  "note": "Don't delete this file! It's used internally to help with page regeneration."
}